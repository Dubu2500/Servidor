<style>
  :root {
    --bg: #f7f9fc;
    --panel: #ffffff;
    --border: #e5e7eb;
    --text: #0f172a;
    --muted: #64748b;
    --primary: #2563eb;
    --primary-600: #1d4ed8;
    --danger: #dc2626;
    --success: #16a34a;
  }
  body { background: var(--bg); color: var(--text); }
  .chat-app { max-width: 900px; margin: 24px auto; padding: 0 16px; }
  .title { margin: 8px 0 16px; font-weight: 700; letter-spacing: .2px; }
  .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 4px 14px rgba(2, 8, 23, 0.05); padding: 16px; margin-bottom: 16px; }
  .hidden { display: none; }

  /* Rooms */
  .room-list { list-style: none; padding: 0; margin: 8px 0 16px; display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; }
  .room-list a { display: inline-block; text-decoration: none; }
  .btn { cursor: pointer; border: 1px solid var(--border); border-radius: 10px; padding: 10px 14px; background: #f8fafc; color: var(--text); transition: all .15s ease; }
  .btn:hover { background: #eef2ff; }
  .btn-primary { background: var(--primary); color: #fff; border-color: var(--primary); }
  .btn-primary:hover { background: var(--primary-600); }
  .btn-ghost { background: transparent; }
  .btn-danger { background: var(--danger); color: #fff; border-color: var(--danger); }

  /* Toolbar */
  #toolbar { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; }
  #toolbar .spacer { flex: 1; }
  .pill { display: inline-block; background: #eef2ff; color: #3730a3; padding: 4px 10px; border-radius: 999px; font-size: 12px; }

  /* Messages */
  #messages { height: 55vh; min-height: 320px; overflow-y: auto; border: 1px solid var(--border); padding: 12px; border-radius: 10px; background: #fbfdff; }
  .msg { margin: 8px 0; padding: 8px 10px; border-radius: 10px; max-width: 70%; box-shadow: 0 2px 6px rgba(2,8,23,0.04); }
  .mine { background: #e3f2fd; margin-left: auto; text-align: right; border: 1px solid #cfe4fb; }
  .others { background: #f1f5f9; margin-right: auto; text-align: left; border: 1px solid #e2e8f0; }
  .system { color: var(--muted); font-style: italic; text-align: center; background: transparent; border: 0; box-shadow: none; }
  .msg small { color: var(--muted); display: block; margin-bottom: 2px; }

  /* Composer */
  .composer { display: flex; gap: 8px; align-items: center; margin-top: 10px; }
  .composer input { flex: 1; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); outline: none; background: #fff; }
  .composer input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.12); }
  .hint { color: var(--muted); margin-left: 6px; }
</style>

<div class="chat-app">
  <h2 class="title">Chat en línea</h2>

  <div id="loginSection" class="card">
    <p>Escribe tu nombre para entrar:</p>
    <div class="composer" style="margin-top:6px;">
      <input type="text" id="nameInput" placeholder="Tu nombre" />
      <button class="btn btn-primary" id="saveNameBtn">Entrar</button>
    </div>
    <p class="hint">El nombre se guarda en sessionStorage y se pierde al cerrar la ventana.</p>
    <div id="loginError" style="color:#b00020; margin-top:6px;"></div>
  </div>

  <div id="roomsSection" class="card hidden">
    <p>Hola <strong id="greetName"></strong>. Elige una sala:</p>
    <ul id="roomsList" class="room-list"></ul>
    <button class="btn btn-ghost" id="logoutBtn">Cerrar sesión</button>
  </div>

  <div id="chatSection" class="card hidden">
    <div id="toolbar">
      <div>Usuario: <span class="pill" id="usernameLabel"></span></div>
      <div>Sala: <span class="pill" id="roomLabel"></span></div>
      <div class="spacer"></div>
      <button class="btn" id="leaveBtn">Salir de la sala</button>
      <button class="btn btn-danger" id="logoutBtn2">Cerrar sesión</button>
    </div>
    <div id="messages"></div>
    <div class="composer">
      <input type="text" id="messageInput" placeholder="Escribe un mensaje" />
      <button class="btn btn-primary" id="sendBtn">Enviar</button>
      <small class="hint" id="hint">Enter para enviar</small>
    </div>
    <div style="margin-top:10px;">
      <button class="btn" id="backToRoomsBtn">Elegir otra sala</button>
    </div>
  </div>
</div>

<script>
  (function () {
    var AVAILABLE_ROOMS = ['General', 'Prueba1', 'Prueba2'];

    var loginSection = document.getElementById('loginSection');
    var roomsSection = document.getElementById('roomsSection');
    var chatSection = document.getElementById('chatSection');
    var nameInput = document.getElementById('nameInput');
    var saveNameBtn = document.getElementById('saveNameBtn');
    var logoutBtn = document.getElementById('logoutBtn');
    var logoutBtn2 = document.getElementById('logoutBtn2');
    var greetName = document.getElementById('greetName');
    var roomsList = document.getElementById('roomsList');
    var usernameLabel = document.getElementById('usernameLabel');
    var roomLabel = document.getElementById('roomLabel');
    var messages = document.getElementById('messages');
    var input = document.getElementById('messageInput');
    var sendBtn = document.getElementById('sendBtn');
    var leaveBtn = document.getElementById('leaveBtn');
    var backToRoomsBtn = document.getElementById('backToRoomsBtn');
    var loginError = document.getElementById('loginError');

    var socket = io('/');
    var username = sessionStorage.getItem('username') || '';
    var currentRoom = '';

    function showLogin() {
      loginSection.classList.remove('hidden');
      roomsSection.classList.add('hidden');
      chatSection.classList.add('hidden');
      nameInput.focus();
    }

    function showRooms() {
      loginSection.classList.add('hidden');
      roomsSection.classList.remove('hidden');
      chatSection.classList.add('hidden');
      greetName.textContent = username;
      renderRooms();
    }

    function showChat() {
      loginSection.classList.add('hidden');
      roomsSection.classList.add('hidden');
      chatSection.classList.remove('hidden');
      usernameLabel.textContent = username;
      roomLabel.textContent = currentRoom;
      input.focus();
    }

    function renderRooms() {
      roomsList.innerHTML = '';
      for (var i = 0; i < AVAILABLE_ROOMS.length; i++) {
        (function (roomName) {
          var li = document.createElement('li');
          var a = document.createElement('a');
          a.href = '#';
          a.textContent = roomName;
          a.addEventListener('click', function (e) {
            e.preventDefault();
            enterRoom(roomName);
          });
          li.appendChild(a);
          roomsList.appendChild(li);
        })(AVAILABLE_ROOMS[i]);
      }
    }

    function appendSystem(text) {
      var p = document.createElement('div');
      p.className = 'msg system';
      p.textContent = text;
      messages.appendChild(p);
      messages.scrollTop = messages.scrollHeight;
    }

    function appendMessage(data) {
      var who = data.username === username ? 'mine' : 'others';
      var div = document.createElement('div');
      div.className = 'msg ' + who;
      var time = new Date(data.timestamp || Date.now());
      var hh = String(time.getHours()).padStart(2, '0');
      var mm = String(time.getMinutes()).padStart(2, '0');
      div.innerHTML = '<small>[' + hh + ':' + mm + '] ' + (who === 'mine' ? 'Yo' : data.username) + '</small><br>' +
                      '<span>' + (data.message || '') + '</span>';
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    if (!username) {
      showLogin();
    } else {
      showRooms();
    }

    saveNameBtn.addEventListener('click', function () {
      var name = (nameInput.value || '').trim();
      if (!name) {
        loginError.textContent = 'Por favor escribe tu nombre';
        return;
      }
      username = name;
      sessionStorage.setItem('username', username);
      loginError.textContent = '';
      showRooms();
    });
    nameInput.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') saveNameBtn.click();
    });

    function enterRoom(roomName) {
      currentRoom = roomName;
      messages.innerHTML = '';
      showChat();
      sendPayload({
        type: 'system',
        action: 'join',
        room: currentRoom,
        username: username,
        message: username + ' se unió a la sala',
        timestamp: new Date().toISOString()
      });
    }

    function leaveRoom() {
      if (!currentRoom) return;
      sendPayload({
        type: 'system',
        action: 'leave',
        room: currentRoom,
        username: username,
        message: username + ' salió de la sala',
        timestamp: new Date().toISOString()
      });
      currentRoom = '';
      showRooms();
    }

    function sendPayload(payload) {
      socket.emit('messageSent', payload);
    }

    function sendCurrent() {
      var text = (input.value || '').trim();
      if (!text || !currentRoom) return;
      sendPayload({
        type: 'chat',
        room: currentRoom,
        username: username,
        message: text,
        timestamp: new Date().toISOString()
      });
      input.value = '';
      input.focus();
    }

    sendBtn.addEventListener('click', sendCurrent);
    input.addEventListener('keydown', function (e) { if (e.key === 'Enter') sendCurrent(); });
    leaveBtn.addEventListener('click', leaveRoom);
    backToRoomsBtn.addEventListener('click', leaveRoom);
    logoutBtn.addEventListener('click', function () {
      if (currentRoom) leaveRoom();
      sessionStorage.removeItem('username');
      username = '';
      showLogin();
    });
    logoutBtn2.addEventListener('click', function () {
      if (currentRoom) leaveRoom();
      sessionStorage.removeItem('username');
      username = '';
      showLogin();
    });

    socket.on('messageReceived', function (data) {
      if (!data || data.room !== currentRoom) return;
      if (data.type === 'system') {
        appendSystem(data.message);
      } else if (data.type === 'chat') {
        appendMessage(data);
      }
    });
    socket.on('confirmacion', function () {});

    window.addEventListener('beforeunload', function () {
      if (username && currentRoom) {
        try {
          sendPayload({
            type: 'system', action: 'leave', room: currentRoom, username: username,
            message: username + ' salió de la sala', timestamp: new Date().toISOString()
          });
        } catch (e) {}
      }
    });
  })();
</script>
